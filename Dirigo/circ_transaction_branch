/*
========================================================================================================================
Retrieve the count of distinct checkout transactions, grouped by CKO Location, Collection, Owning Location, Material Type, Patron Code, and Statistical Code within a specified date range.
This version uses a Common Table Expression (CTE) to consolidate fetching attributes from TransactionDetails.
Updated to reflect that CollectionID (from SubTypeID 61) can be NULL,
while OwningBranchID (from SubTypeID 125) must be present.
Aliases for CKO and Owning locations, and their corresponding Organization table joins, have been clarified.
========================================================================================================================
*/

WITH TransactionDetailAttributes AS (
    -- This CTE retrieves the CollectionID and OwningBranchID from the TransactionDetails table.
    -- It pivots rows to columns for a given TransactionID.
    SELECT
        TransactionID,
        MAX(CASE WHEN TransactionSubTypeID = 61 THEN numValue END) AS CollectionIDValue,       -- Extracts CollectionID if TransactionSubTypeID is 61 (can be NULL)
        MAX(CASE WHEN TransactionSubTypeID = 125 THEN numValue END) AS OwningBranchIDValue,     -- Extracts OwningBranchID if TransactionSubTypeID is 125 (must be present)
	MAX(CASE WHEN TransactionSubTypeID = 4 THEN numValue END) AS MaterialTypeIDValue,     -- Extracts MaterialTypeID if TransactionSubTypeID is 4 (must be present)
 	MAX(CASE WHEN TransactionSubTypeID = 7 THEN numValue END) AS PatronCodeIDValue,     -- Extracts PatronCodeID if TransactionSubTypeID is 7 (must be present)
	MAX(CASE WHEN TransactionSubTypeID = 60 THEN numValue END) AS ItemStatisticalCodeIDValue     -- Extracts ItemStatisticalCodeID if TransactionSubTypeID is 60 (must be present)
    FROM
        PolarisTransactions.Polaris.TransactionDetails
    WHERE
        TransactionSubTypeID IN (4, 7, 60, 61, 125) -- Filter for relevant subtypes early
    GROUP BY
        TransactionID
    HAVING
        -- Ensure that the OwningBranchIDValue (from SubTypeID 125) was found for the TransactionID.
        -- CollectionIDValue (from SubTypeID 61) can be NULL.
        MAX(CASE WHEN TransactionSubTypeID = 125 THEN numValue END) IS NOT NULL
)
SELECT
    CKO_Org.Abbreviation AS [CKOLocation],        -- The name of the CKO (Checkout Organization) location where the transaction occurred.
    C.Abbreviation AS [collection],            -- The name of the collection to which the checked-out item belongs, aliased as collection.name. (Will be NULL if CollectionIDValue is NULL)
    Owning_Org.Abbreviation AS [OwningLocation],  -- The name of the Owning Location/Branch organization.
    MT.Description AS [MaterialType],  		--The material type description	
    SC.Description AS [StatisticalCode],	-- The statistical code.
    P.Description AS [PatronCode],		-- The patron code.	
        COUNT(DISTINCT TH.TransactionID) AS CirculationCount -- The total number of unique checkout transactions.
FROM
    PolarisTransactions.Polaris.TransactionHeaders TH
/*
Join the CTE to get CollectionID and OwningBranchID for each transaction.
This replaces the two separate JOINs to PolarisTransactions.Polaris.TransactionDetails.
*/
JOIN
    TransactionDetailAttributes TDA
    ON TH.TransactionID = TDA.TransactionID
/*
Left Join Collections table to translate CollectionIDValue (from TDA) into a Collection Name.
A LEFT JOIN is used because TDA.CollectionIDValue can be NULL (if no SubTypeID 61 was present or its numValue was NULL).
If TDA.CollectionIDValue is NULL, C.Name will also be NULL.
*/
LEFT JOIN
    Polaris.Polaris.Collections C
    ON C.CollectionID = TDA.CollectionIDValue
/*
Join Organizations table to get the CKO Location Name based on the OrganizationID from TransactionHeaders.
This is aliased as 'CKO_Org'.
*/
JOIN
    Polaris.Polaris.Organizations CKO_Org -- Alias for the CKO Location's Organization table
    ON CKO_Org.OrganizationID = TH.OrganizationID
/*
Join Organizations table AGAIN to get the Owning Location Name.
We use the TDA.OwningBranchIDValue (which is the Owning Branch's OrganizationID)
to link to the Organizations table. This is aliased as 'Owning_Org'.
Since OwningBranchIDValue is guaranteed by the CTE's HAVING clause, an INNER JOIN is appropriate here,
assuming all OwningBranchIDValues have a match in the Organizations table.
Consider a LEFT JOIN if an OwningBranchIDValue might not always exist in the Organizations table.
*/
JOIN
    Polaris.Polaris.Organizations Owning_Org -- Alias for the Owning Location's Organization table
    ON Owning_Org.OrganizationID = TDA.OwningBranchIDValue
JOIN Polaris.Polaris.MaterialTypes MT -- Alias for the Material Type table
    ON MT.MaterialTypeID = TDA.MaterialTypeIDValue
JOIN Polaris.Polaris.StatisticalCodes SC -- Alias for Statistical Codes table
    ON SC.StatisticalCodeID = TDA.ItemStatisticalCodeIDValue
JOIN Polaris.Polaris.PatronCodes P -- Alias for the Patron Code table
    ON P.PatronCodeID = TDA.PatronCodeIDValue
WHERE
    -- Filter for checkout transactions.
    TH.TransactionTypeID = 6001 -- Assumed to be the ID for checkout transactions.
    AND
    -- Filter transactions within the specified date range.
    TH.TranClientDate BETWEEN '2025-04-01' AND '2025-05-01' -- Standardized date format.
GROUP BY
    CKO_Org.Abbreviation,                     -- Group results by CKO Location abbrev.
    Owning_Org.Abbreviation,                  -- Then, by Owning Location abbrev.
    MT.Description,			-- Then, group results by Material Type. 	
    C.Abbreviation,			-- Then, group results by Collection Name. (Will group NULLs for collection.name together)
    P.Description,			---Then, group results by Patron Code.
    SC.Description                        ---Then, group results by Statistical Code.   
ORDER BY
    CKO_Org.Abbreviation,                     -- Sort results by CKO Location abbrev.
    Owning_Org.Abbreviation,                  -- Then, by Owning Location abbrev.
    MT.Description,				---Then, by Material Type.
    C.Abbreviation,				---Then, by Collection abbrev.
    P.Description,				--Then, by Patron Code.
    SC.Description                        -- Then, sort by Collection Name.
